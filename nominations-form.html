<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Nominations Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body class="page-nominations-form">
  <!-- Exit button -->
  <a class="exit-btn" href="nominations.html" onclick="if (history.length>1){history.back(); return false;}">⟵ Exit</a>

  <!-- Moon -->
  <header class="site-header">
    <img src="moon.png" alt="Full Moon" class="moon" />
  </header>

  <main class="container">
    <h1>Phase 1: Nominations</h1>
    <p class="intro">You can skip any question and go back before submitting.</p>

    <div class="wizard" id="wizard">
      <div class="progress" id="progress">Step 1 of 15</div>

      <!-- Question area -->
      <div id="step"></div>

      <!-- Honeypot (hidden from humans, visible to bots) -->
      <div class="hp-wrap" aria-hidden="true">
        <label>Website
          <input type="text"
                 id="website"
                 name="website"
                 autocomplete="off"
                 tabindex="-1"
                 inputmode="text"
                 spellcheck="false">
        </label>
      </div>

      <!-- Controls -->
      <div class="controls" id="controls">
        <button class="btn" id="backBtn" type="button" onclick="goBack()">← Back</button>
        <button class="btn" id="nextBtn" type="button" onclick="nextStep()">Next →</button>
        <button class="btn" id="submitBtn" type="button" style="display:none;" onclick="submitForm()">Submit</button>
      </div>

      <!-- Results -->
      <div id="result"></div>
    </div>
  </main>

  <script>
    /* ===== CONFIG ===== */
    var FORM_ENDPOINT = 'https://script.google.com/macros/s/AKfycbzeNpP7xO_6P85VUfzGpMnSfXXgkBU5ML55teNV8njQgjMxV9POBfZvgfczwATqp-TR8g/exec';

    /* ===== STATE ===== */
    var startTime = Date.now();
    var months = ['January','February','March','April','May','June',
                  'July','August','September','October','November','December'];

    var steps = [];
    var state = {
      name: '',
      email: '',
      months: months.map(m => ({ month: m, name: '', explanation: '' })),
      captchaAns: ''
    };
    var i = 0;

    /* ===== BUILD STEPS ===== */
    steps.push({
      key: 'name',
      render: () => `
        <div class="step-title">1) What is your name?</div>
        <div class="q">
          <input id="name" type="text" placeholder="Your name (optional)" autocomplete="name">
          <div class="subtext">You can skip if you prefer.</div>
        </div>`
    });
    steps.push({
      key: 'email',
      render: () => `
        <div class="step-title">2) What is your email address?</div>
        <div class="q">
          <input id="email" type="email" placeholder="you@example.com (optional)" autocomplete="email">
          <div class="subtext">We’ll send you updates. You can skip.</div>
        </div>`
    });
    months.forEach((m, idx) => {
      steps.push({
        key: 'm' + idx,
        month: m,
        render: () => `
          <div class="step-title">${idx+3}) ${m}: Suggest a name for the full moon</div>
          <div class="two-col">
            <div class="q"><input id="moonName" type="text" placeholder="Moon name (optional)"></div>
            <div class="q"><textarea id="moonExplanation" placeholder="Brief, optional explanation"></textarea></div>
          </div>
          <div class="subtext">You can skip if you like.</div>`
      });
    });
    steps.push({
      key: 'captcha',
      render: () => {
        window._a = Math.floor(Math.random()*8)+2;
        window._b = Math.floor(Math.random()*8)+2;
        return `
          <div class="step-title">Last step: quick human check</div>
          <div class="q">
            <label for="captchaAns">What is <strong>${window._a} + ${window._b}</strong>?</label>
            <input id="captchaAns" type="number" inputmode="numeric" placeholder="Answer required to submit">
          </div>
          <div class="subtext">This helps prevent spam.</div>`;
      }
    });

    /* ===== ELEMENTS ===== */
    var stepContainer = document.getElementById('step');
    var progressEl   = document.getElementById('progress');
    var backBtn      = document.getElementById('backBtn');
    var nextBtn      = document.getElementById('nextBtn');
    var submitBtn    = document.getElementById('submitBtn');
    var resultEl     = document.getElementById('result');
    var controlsWrap = document.getElementById('controls');

    /* ===== RENDER ===== */
    function render() {
      stepContainer.innerHTML = steps[i].render();
      progressEl.textContent = 'Step ' + (i + 1) + ' of ' + steps.length;

      var onLast = (i === steps.length - 1);
      backBtn.style.visibility = (i === 0 ? 'hidden' : 'visible');
      nextBtn.style.display    = (onLast ? 'none' : 'inline-block');
      submitBtn.style.display  = (onLast ? 'inline-block' : 'none');

      resultEl.innerHTML = '';
      refill();
    }

    /* ===== STATE HANDLERS ===== */
    function collectCurrentStep(saveEmpty) {
      var s = steps[i];
      if (s.key === 'name') {
        state.name = (document.getElementById('name')?.value || '').trim();
      } else if (s.key === 'email') {
        state.email = (document.getElementById('email')?.value || '').trim();
      } else if (s.month) {
        var n = document.getElementById('moonName')?.value.trim();
        var e = document.getElementById('moonExplanation')?.value.trim();
        var idx = months.indexOf(s.month);
        if (idx >= 0) state.months[idx] = { month: s.month, name: n, explanation: e };
      } else if (s.key === 'captcha') {
        state.captchaAns = (document.getElementById('captchaAns')?.value || '').trim();
      }
    }
    function refill() {
      var s = steps[i];
      if (s.key === 'name') document.getElementById('name').value = state.name;
      if (s.key === 'email') document.getElementById('email').value = state.email;
      if (s.month) {
        var idx = months.indexOf(s.month);
        document.getElementById('moonName').value = state.months[idx].name;
        document.getElementById('moonExplanation').value = state.months[idx].explanation;
      }
      if (s.key === 'captcha') document.getElementById('captchaAns').value = state.captchaAns;
    }

    /* ===== BUTTONS ===== */
    function goBack(){ collectCurrentStep(true); i=Math.max(0,i-1); render(); }
    function nextStep(){ collectCurrentStep(true); i=Math.min(steps.length-1,i+1); render(); }
    function submitForm(){
      collectCurrentStep(false);
      var website = document.getElementById('website')?.value || '';
      var elapsedMs = Date.now() - startTime;

      var a=window._a, b=window._b, ans=Number(state.captchaAns);
      if(!isFinite(ans)){
        resultEl.innerHTML='<div class="error">❌ Please solve the quick math check.</div>'; return;
      }

      var payload = {
        website, elapsedMs,
        captcha:{a:a,b:b,ans:ans},
        name: state.name, email: state.email, months: state.months
      };

      backBtn.disabled = nextBtn.disabled = submitBtn.disabled = true;
      fetch(FORM_ENDPOINT, {
        method:'POST',
        headers:{'Content-Type':'text/plain;charset=utf-8'},
        body: JSON.stringify(payload),
        mode:'cors'
      })
      .then(r=>r.json())
      .then(data=>{
        if(data && data.ok){
          stepContainer.innerHTML='';
          controlsWrap.style.display='none';
          resultEl.innerHTML='<div class="success">✅ Thanks! Your nominations were recorded.</div>';
          progressEl.textContent='Done';
        }else throw new Error(data?.error || 'Unknown error');
      })
      .catch(err=>{
        console.error(err);
        resultEl.innerHTML='<div class="error">❌ Submission failed: '+String(err)+'</div>';
      })
      .finally(()=>{ backBtn.disabled = nextBtn.disabled = submitBtn.disabled = false; });
    }

    window.goBack=goBack; window.nextStep=nextStep; window.submitForm=submitForm;

    render();
  </script>
</body>
</html>
