<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Phase 1: Nominations</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .wizard {
      width: 100%; max-width: 820px; margin: 2rem auto; padding: 1.25rem;
      border: 2px solid #ffd700; border-radius: 20px;
      box-shadow: 0 0 15px rgba(255,215,0,0.5); background: rgba(13,11,41,0.85);
      text-align: left;
    }
    .step-title { font-size: 1.25rem; margin: 0 0 0.75rem; }
    .q { display:flex; flex-direction:column; gap:0.5rem; margin:0.5rem 0 1rem; }
    .q input, .q textarea { padding:0.8rem; border-radius:12px; border:1px solid #ffd700; background:transparent; color:#ffd700; }
    .q textarea { min-height:110px; }
    .controls { display:flex; gap:0.75rem; flex-wrap:wrap; margin-top:1rem; }
    .btn {
      padding:0.8rem 1.2rem; border:2px solid #ffd700; border-radius:22px; background:transparent;
      color:#ffd700; font-weight:700; cursor:pointer; text-decoration:none;
      box-shadow:0 0 8px rgba(255,215,0,0.4);
      transition: transform .2s, box-shadow .2s, background .2s;
    }
    .btn:hover { transform:scale(1.03); box-shadow:0 0 15px rgba(255,215,0,0.8); background:rgba(255,215,0,0.12); }
    .progress { margin:0.25rem 0 1rem; font-size:0.95rem; opacity:0.9; }
    .success,.error { margin-top:1rem; padding:0.8rem 1rem; border-radius:12px; background:rgba(0,0,0,0.25); }
    .success { border:1px solid #34d399; color:#b2f5ea; }
    .error { border:1px solid #f87171; color:#fecaca; }
    .two-col { display:grid; grid-template-columns:1fr; gap:0.75rem; }
    @media (min-width:640px){ .two-col{ grid-template-columns:1fr 1fr; } }
    .subtext { font-size: 0.9rem; opacity: 0.85; margin-top: -0.25rem; }
    /* Honeypot hidden off-screen */
    .hp-wrap { position:absolute; left:-10000px; top:auto; width:1px; height:1px; overflow:hidden; }
  </style>
</head>
<body>
  <!-- Moon image -->
  <img src="moon.png" alt="Full Moon" class="moon">

  <!-- Nav -->
  <nav>
    <a href="index.html">About</a>
    <a href="nominations.html">Phase 1: Nominations</a>
    <a href="voting.html">Phase 2: Voting</a>
  </nav>

  <main>
    <h1>Phase 1: Nominations</h1>
    <p>You can skip any question and return before submitting.</p>

    <div class="wizard" id="wizard">
      <div class="progress" id="progress">Step 1 of 15</div>
      <div id="step"></div>

      <!-- Honeypot (bots will fill; humans won't see it) -->
      <div class="hp-wrap">
        <label>Website <input type="text" id="website" autocomplete="off"></label>
      </div>

      <div class="controls">
        <button class="btn" id="backBtn" type="button">← Back</button>
        <button class="btn" id="skipBtn" type="button">Skip</button>
        <button class="btn" id="nextBtn" type="button">Next →</button>
        <button class="btn" id="submitBtn" type="button" style="display:none;">Submit</button>
      </div>

      <div id="result"></div>
    </div>
  </main>

  <script>
    // === CONFIG ===
    const FORM_ENDPOINT = 'https://script.google.com/macros/s/AKfycbzeNpP7xO_6P85VUfzGpMnSfXXgkBU5ML55teNV8njQgjMxV9POBfZvgfczwATqp-TR8g/exec';
    const startTime = Date.now(); // for human-time check

    const months = ['January','February','March','April','May','June',
                    'July','August','September','October','November','December'];

    // Steps: name, email, 12 months (name+explanation), captcha
    const steps = [
      { key: 'name', render: () => `
        <div class="step-title">1) What is your name?</div>
        <div class="q">
          <input id="name" type="text" placeholder="Your name (optional)">
          <div class="subtext">You can skip if you prefer.</div>
        </div>`},
      { key: 'email', render: () => `
        <div class="step-title">2) What is your email address?</div>
        <div class="q">
          <input id="email" type="email" placeholder="you@example.com (optional)">
          <div class="subtext">We’ll send you updates. You can skip.</div>
        </div>`},
      ...months.map((m, idx) => ({
        key: `m${idx}`, month: m,
        render: () => `
          <div class="step-title">${idx+3}) ${m}: Suggest a name for the full moon</div>
          <div class="two-col">
            <div class="q"><input id="moonName" type="text" placeholder="Moon name (optional)"></div>
            <div class="q"><textarea id="moonExplanation" placeholder="Brief, optional explanation"></textarea></div>
          </div>
          <div class="subtext">You can skip if you like.</div>`
      })),
      { key: 'captcha', render: () => {
          window._a = Math.floor(Math.random()*8)+2; // 2..9
          window._b = Math.floor(Math.random()*8)+2;
          return `
            <div class="step-title">Last step: quick human check</div>
            <div class="q">
              <label for="captchaAns">What is <strong>${window._a} + ${window._b}</strong>?</label>
              <input id="captchaAns" type="number" inputmode="numeric" placeholder="Answer required to submit">
            </div>
            <div class="subtext">This helps prevent spam.</div>`;
        }
      }
    ];

    const state = {
      name: '', email: '',
      months: months.map(m => ({ month: m, name: '', explanation: '' })),
      captchaAns: ''
    };

    let i = 0;
    const stepContainer = document.getElementById('step');
    const progressEl = document.getElementById('progress');
    const backBtn = document.getElementById('backBtn');
    const skipBtn = document.getElementById('skipBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    const resultEl = document.getElementById('result');

    function render() {
      stepContainer.innerHTML = steps[i].render();
      progressEl.textContent = `Step ${i+1} of ${steps.length}`;
      backBtn.style.visibility = i === 0 ? 'hidden' : 'visible';
      // Captcha step cannot be skipped
      const onCaptcha = steps[i].key === 'captcha';
      skipBtn.style.display = onCaptcha ? 'none' : 'inline-block';
      nextBtn.style.display = i < steps.length - 1 ? 'inline-block' : 'none';
      submitBtn.style.display = i === steps.length - 1 ? 'inline-block' : 'none';
      resultEl.innerHTML = '';
      refill();
    }

    function collectCurrentStep(saveEmpty=false) {
      const s = steps[i];
      if (s.key === 'name') {
        const v = (document.getElementById('name')?.value || '').trim();
        if (v || saveEmpty) state.name = v;
      } else if (s.key === 'email') {
        const v = (document.getElementById('email')?.value || '').trim();
        if (v || saveEmpty) state.email = v;
      } else if (s.month) {
        const name = (document.getElementById('moonName')?.value || '').trim();
        const explanation = (document.getElementById('moonExplanation')?.value || '').trim();
        const idx = months.indexOf(s.month);
        if (idx >= 0 && (name || explanation || saveEmpty)) {
          state.months[idx] = { month: s.month, name, explanation };
        }
      } else if (s.key === 'captcha') {
        state.captchaAns = (document.getElementById('captchaAns')?.value || '').trim();
      }
    }

    function refill() {
      const s = steps[i];
      if (s.key === 'name') document.getElementById('name')?.value = state.name || '';
      else if (s.key === 'email') document.getElementById('email')?.value = state.email || '';
      else if (s.month) {
        const idx = months.indexOf(s.month), rec = state.months[idx] || {};
        const n = document.getElementById('moonName'), e = document.getElementById('moonExplanation');
        if (n) n.value = rec.name || '';
        if (e) e.value = rec.explanation || '';
      } else if (s.key === 'captcha') {
        const el = document.getElementById('captchaAns'); if (el) el.value = state.captchaAns || '';
      }
    }

    backBtn.addEventListener('click', () => { collectCurrentStep(true); i = Math.max(0, i-1); render(); });
    skipBtn.addEventListener('click', () => { collectCurrentStep(true); i = Math.min(steps.length-1, i+1); render(); });
    nextBtn.addEventListener('click', () => { collectCurrentStep(false); i = Math.min(steps.length-1, i+1); render(); });

    submitBtn.addEventListener('click', async () => {
      collectCurrentStep(false);
      const website = document.getElementById('website')?.value || ''; // honeypot
      const elapsedMs = Date.now() - startTime;

      // Require captcha answer
      const a = window._a, b = window._b, ans = Number(state.captchaAns);
      if (!Number.isFinite(ans)) {
        resultEl.innerHTML = `<div class="error">❌ Please solve the quick math check.</div>`;
        return;
      }

      const payload = {
        website,           // honeypot (should be empty)
        elapsedMs,         // human-time
        captcha: { a, b, ans },
        name: state.name || '',
        email: state.email || '',
        months: state.months
      };

      try {
        backBtn.disabled = skipBtn.disabled = nextBtn.disabled = submitBtn.disabled = true;
        const res = await fetch(FORM_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // avoids preflight/CORS
          body: JSON.stringify(payload),
          mode: 'cors'
        });
        const data = await res.json();
        if (data.ok) {
          resultEl.innerHTML = `<div class="success">✅ Thanks! Your nominations were recorded.</div>`;
        } else {
          throw new Error(data.error || 'Unknown error');
        }
      } catch (err) {
        resultEl.innerHTML = `<div class="error">❌ Submission failed: ${String(err)}</div>`;
      } finally {
        backBtn.disabled = skipBtn.disabled = nextBtn.disabled = submitBtn.disabled = false;
      }
    });

    // Init
    render();
  </script>
</body>
</html>
